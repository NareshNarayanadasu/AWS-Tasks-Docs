#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Function to print messages
log() {
  echo -e "\e[32m$1\e[0m"
}

log "1. Setting Hostname for the Worker Node"
# Replace 'k8sworker1.example.net' with the appropriate hostname for each worker node.
sudo hostnamectl set-hostname "k8sworker1.example.net"

log "2. Updating Package Lists"
sudo apt-get update

log "3. Installing Dependencies"
sudo apt-get install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates

log "4. Adding Docker's Official GPG Key"
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

log "5. Setting Up the Docker Stable Repository"
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

log "6. Installing containerd"
sudo apt-get update
sudo apt-get install -y containerd.io

log "7. Configuring containerd"
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

log "8. Restarting and Enabling containerd"
sudo systemctl restart containerd
sudo systemctl enable containerd

log "9. Verifying containerd Status"
sudo systemctl status containerd

log "10. Loading Necessary Kernel Modules"
cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

log "11. Setting Up Required sysctl Parameters"
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
sudo sysctl --system

log "12. Downloading Kubernetes Repository GPG Key"
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

log "13. Adding Kubernetes Repository"
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

log "14. Installing Kubernetes Tools"
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

log "15. Disabling Swap"
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

log "16. Joining the Kubernetes Cluster"
# Replace the token and hash values with those generated by the master node during initialization.
#sudo kubeadm join k8smaster.example.net:6443 --token <your-token> --discovery-token-ca-cert-hash sha256:<your-hash>

#log "Kubernetes Worker Node setup is complete."
